<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On Process: Planning for Tech Success in Government</title>
    <meta name="description" content="Evan Savage&#39;s personal blog about software, life, travel, and other sundry things.">
    <link href='https://fonts.googleapis.com/css?family=PT%20Serif:400,400italic,500,500italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Evan Savage // Blog Archive">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Evan Savage // Blog Archive">

    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
        },
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-07YLDJQ67V"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-07YLDJQ67V');
    </script>
  </head>
  <body>
    <header>
      <div class="home"><a href="/">Evan Savage // Blog Archive</a></div>

      <div class="spacer"></div>

      <ul class="nav">
        <li class="nav-item">
          <a href="https://savageevan.com">New Blog!</a>
        </li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>On Process: Planning for Tech Success in Government</h1>

<p><img src="/img/savageinternet/dilbert-agile.gif" alt="Header Image" title="Dilbert comic strip.  PHB: We're going to try something called Agile Programming. // That means no more planning and no more documentation.  Just start writing code and complaining. // Wally: I'm glad it has a name.  // PHB: That was your training."></p>
<p>In this long-overdue reboot of the Savage Internet blog, I talk about setting up a modern web application development environment at the City of Toronto, as part of my <a href="https://medium.com/code-for-canada/meet-the-2018-code-for-canada-fellows-595726b85817">Code for Canada fellowship project</a>.  This is a follow-up to <a href="https://c4ctoronto2018.tumblr.com/post/182766024156/on-process">this less technical intro</a> on our <a href="https://c4ctoronto2018.tumblr.com/">team Tumblr</a> (which you should also check out!)</p>
<p>Let's dive in!</p>
<h1 id="getting-access">Getting Access <a class="direct-link" href="#getting-access">#</a></h1>
<p>My first goal was to get admin access on our City IT-issued development machine.  To do that, I had to send in an Elevated Access Request, wait a week, make sure the account worked, install City certificates on the laptop for VPN access, call IT a couple of times to fix issues that popped up.  (Hey, we were warned that some of this could take a while.)</p>
<p>While I waited, I asked around for the database access we needed.  Our project involves working with 25 years of existing City collision and traffic volume data - but to work effectively with that data, we needed to understand it first!  I started by requesting read-only access, which was easier for IT to grant.  This gave us breathing room to build trust with stakeholders and show value through our user research process, which made it much easier 2 months later when I asked for the full access we needed.</p>
<p>In the meantime, I'd also bought myself valuable technical planning time.</p>
<h1 id="technical-interviews">Technical Interviews <a class="direct-link" href="#technical-interviews">#</a></h1>
<p>To make an informed plan, however, I first needed to know more about the available tools, services, and technical capacity at the City.  Time for some interviews!  In parallel with our <a href="https://c4ctoronto2018.tumblr.com/post/180411008431/user-interviews-action-shot-here-were">user interviews</a>, I held technical interviews with key IT groups:</p>
<ul>
<li><a href="https://portal0.cf.opendata.inter.sandbox-toronto.ca/">Open Data</a>: How can we help you publish more collision and traffic volume data?  What do your data publishing systems look like?  Do you have standards around timestamps, locations, or other fields?</li>
<li><a href="https://www.toronto.ca/311/knowledgebase/kb/docs/contacts/information-and-technology/contact-list-information-and-technology-enterprise-solutions-delivery-geospatial-competency-centre.html">Geospatial Competency Centre</a>: How often are your basemaps updated?  How current is the <a href="https://portal0.cf.opendata.inter.sandbox-toronto.ca/dataset/toronto-centreline-tcl-2/">centreline data</a> on Open Data?  How can we help you share more collision and traffic volume data internally?</li>
<li><a href="https://www.toronto.ca/services-payments/streets-parking-transportation/road-safety/big-data-innovation-team/">Big Data Innovation Team</a> (BDIT): What tools, languages, and types of development are you familiar with?  What would make it easier for you to sustain this project after our fellowship?</li>
<li>Data Owners: Where would I find documentation on these datasets?  What pitfalls should I be aware of in using them?  Which parts of these datasets are considered sensitive?</li>
</ul>
<p>After all, these IT groups are <em>also</em> users of the systems we're building, so it's equally important to get their input during the research process!</p>
<h1 id="data-map">Data Map <a class="direct-link" href="#data-map">#</a></h1>
<p>By this point, insights were starting to roll in from our user interviews.  To combine that emerging picture with what I'd learned from technical interviews, I mapped out how data moved around the organization.  The first version of this &quot;data map&quot; was hastily scrawled on a whiteboard:</p>
<p><img src="/img/savageinternet/data-map-whiteboard.jpg" alt="Whiteboard Data Map" title="Whiteboard flowchart showing how collision and traffic volume data move between organizations and divisions at the City of Toronto"></p>
<p>As it turned out, this was the perfect place to put it.  Whenever someone in our office noticed a problem with our map, they'd approach us to help fix it - hallway testing isn't just for software!  Eventually, we expanded this into a more polished version:</p>
<p><img src="/img/savageinternet/data-map-printed.jpg" alt="Printed Data Map" title="Printed data map, complete with fancy colours and names attached to the various divisions"></p>
<p>This data map proved invaluable in user research: when we went to interview users, we could situate their use case on this map and understand how they fit in with the broader technical picture.</p>
<h1 id="tech-strategy">Tech Strategy <a class="direct-link" href="#tech-strategy">#</a></h1>
<p>User interviews went on, and we continued to refine our understanding of the services we'd come to improve.  On the tech side, this allowed me to coalesce technical requirements, goals, and opportunities into a Tech Strategy:</p>
<p><img src="/img/savageinternet/tech-strategy-header.png" alt="Tech Strategy Header" title="Header of our tech strategy document, detailing our high-level goals"></p>
<p>As you can see, it's a living document rather than a strict specification: I update this as requirements, goals, and opportunities change.  You can <a href="https://www.notion.so/bditto/Tech-Strategy-a25662cff3304c6d9b4f54244fe08912">read the full text on Notion</a>.  This gave us a way to clearly communicate our technical plans to our stakeholders, and it gave them something specific to provide feedback on.</p>
<h1 id="the-cloud">The Cloud <a class="direct-link" href="#the-cloud">#</a></h1>
<p>We'd been discussing cloud deployment from Day 1.  As it turned out, BDIT had a EC2 instance and PostgreSQL RDS, and they were looking to serve webapps from it.  This led to an early win-win: I helped them set up <a href="https://www.nginx.com/">nginx</a>, they shared <code>sudo</code> access to their EC2 instance.</p>
<p>This was only a temporary solution, though - fine for early prototyping, but you don't want to be running production software on someone else's experimental data analysis machine.  On BDIT's suggestion, we reached out to Cloud Services for an initial chat, where they explained their available AWS stack to us:</p>
<p><img src="/img/savageinternet/vpc-elb-stack.png" alt="Tech Strategy Header" title="City of Toronto AWS stack"></p>
<p>Here we have an <a href="https://aws.amazon.com/autoscaling/">autoscaling pool</a> behind an <a href="https://aws.amazon.com/elasticloadbalancing/">Elastic Load Balancer</a>, all backed by a <a href="https://aws.amazon.com/rds/postgresql/">PostgreSQL RDS</a>, and all within a <a href="https://aws.amazon.com/vpc/">Virtual Private Cloud</a>.  Perfect!  I updated our Tech Strategy to take this new environment into account and came up with these specific asks:</p>
<ul>
<li>a <em>main stack</em> for serving our webapp;</li>
<li>a <em>transfer EC2 instance</em> for moving data from Oracle to PostgreSQL.</li>
</ul>
<p>Having a clear Tech Strategy shifted this discussion from &quot;OK, so what do you need?&quot; to &quot;What else can Cloud Services provide?&quot;  A lot, as it turned out:</p>
<ul>
<li>ready-made <a href="https://aws.amazon.com/cloudformation/">CloudFormation</a> templates to provision EC2 instances;</li>
<li>production-ready, City-approved SSL certificates;</li>
<li>help with setting up <a href="https://openid.net/connect/">OpenID Connect</a>-based authentication;</li>
<li>ongoing work to move to the <a href="https://aws.amazon.com/about-aws/whats-new/2016/12/announcing-the-aws-canada-central-region/">AWS Canada (Central) region</a> to mitigate data territoriality concerns;</li>
<li>CodeDeploy / CodePipeline integration for CI / CD.</li>
</ul>
<p>In turn, the backing of Cloud Services helped convince stakeholders that we could deploy to the cloud while preserving data privacy.</p>
<h1 id="choosing-a-tech-stack">Choosing a Tech Stack <a class="direct-link" href="#choosing-a-tech-stack">#</a></h1>
<p>With our Tech Strategy in hand, and our City-approved AWS stack set to arrive, it was time to decide on a tech stack for the product.</p>
<p>This part depends on many factors:</p>
<ul>
<li>the <em>development team</em>: Who's developing this, and what skills do they have?  Which tools / frameworks are they most familiar with?</li>
<li>the <em>project</em>: What's the timeline and budget for the project?  How robust does it have to be?</li>
<li>the <em>users</em>: What problem do they need solved?  What forms do potential solutions take?  How technically savvy are they?</li>
<li>the <em>organization</em>: What skills does the organization have access to?  What will help them maintain the product?  What are their requirements around security, accessibility, perfomance, open-source licensing, etc.?</li>
<li>the <em>tech ecosystem</em>: Which tools and frameworks solve the problem?  What are the tradeoffs between them?  Which tradeoffs make the most sense?</li>
</ul>
<p>You can't answer these questions without a clear direction based on user and technical research - otherwise, you're stabbing in the dark!  Getting to that stage took several weeks, a couple dozen interviews, countless email chains, face-to-face meetings with BDIT, and enough post-it notes to put some 3M exec's kids through school.</p>
<p>It took a <em>lot</em> of work, but we got to a working hypothesis:</p>
<blockquote cite="undefined">
  <p>
We believe that by creating an integrated data platform for Data Supervisors and Traffic Ops, we’ll achieve a seamless count and collision request to warrant process as well as trust and shared understanding.
</p>
  <footer>&ndash; January Project Panel Slides, <cite><a href="undefined">undefined</a></footer>
</blockquote>
<p>Given everything we'd learned, this likely meant a user-facing web application plus some eventual scripting work to automate data intake, validation, and publishing pipelines.  From here, I could plan the webapp tech stack.</p>
<h2 id="database">Database <a class="direct-link" href="#database">#</a></h2>
<p><a href="https://www.postgresql.org/">PostgreSQL</a> was the clear choice here.  BDIT has extensive experience with PostgreSQL, Cloud Services offers PostgreSQL, Open Data is using PostgreSQL already, GCC is moving onto PostgreSQL, and so on.  Everywhere we looked, divisions were either already using PostgreSQL or seriously considering it.</p>
<p>It helps, of course, that PostgreSQL is a mature, well-tested database platform with excellent geospatial support through <a href="https://postgis.net/">PostGIS</a>.</p>
<h2 id="web-application-server">Web Application Server <a class="direct-link" href="#web-application-server">#</a></h2>
<p>Python and JavaScript were the two main candidates here, as both were supported by Cloud Services and familiar to BDIT.  I decided on JavaScript, as I have more experience with node.js-based webapps.  (This is a reasonable rule of thumb: all else being equal, use what you're most familiar with!)</p>
<p>From there, it was a matter of picking a node.js-based web framework.  <a href="https://expressjs.com/">express</a> used to be the default choice here, but development has slowed recently to the point where its future is uncertain.  I ultimately settled on <a href="https://hapijs.com/">hapi</a>, initially developed by Walmart Labs to handle Black Friday traffic.  It's popular, the community is active, there's decent documentation, it supports <code>async</code> route handling, and it comes with <a href="https://github.com/code-for-canada/bdit-webapp-template/blob/master/server.js#L16">out-of-box security header support</a>:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token comment">// other stuff...</span><br>  <span class="token literal-property property">routes</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">security</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token literal-property property">hsts</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">2592000</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">includeSubdomains</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">preload</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">xframe</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">xss</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">noOpen</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">noSniff</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">referrer</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h2 id="web-frontend">Web Frontend <a class="direct-link" href="#web-frontend">#</a></h2>
<p>Reactive component frameworks like <a href="https://reactjs.org/">React</a> and <a href="https://vuejs.org/">Vue</a> take an age-old problem in webapp UI development - keeping the UI in sync with changing state - and they solve it well.  They can be overkill for smaller projects, but the modularity they enforce makes it much easier to manage larger webapp projects.</p>
<p>I chose Vue here: I'm more familiar with it than with React, and I prefer its clear separation of HTML, JS, and CSS code.  (See the above rule of thumb.)</p>
<h2 id="static-resources-toolchain">Static Resources Toolchain <a class="direct-link" href="#static-resources-toolchain">#</a></h2>
<p>This is usually the most confusing part for new webapp developers: transpiling, minifying, bundling, preprocessing, and so on.  Where to start?  Which tools to pick?  How to configure them?</p>
<p>At the same time, these tools are all valuable, as they enable the use of modern HTML, JS, and CSS features while maintaining cross-browser support:</p>
<ul>
<li><a href="https://github.com/browserslist/browserslist">browserslist</a> defines supported browsers;</li>
<li><a href="https://postcss.org/">PostCSS</a> plus <a href="https://github.com/postcss/postcss-nested">postcss-nested</a> preprocesses CSS, allowing you to use modern CSS features while maintaining compatibility with browsers defined in <code>browserslist</code>;</li>
<li><a href="https://babeljs.io/">Babel</a> does for JavaScript what <code>postcss</code> does for CSS, allowing you to use ES6+ features while maintaining browser support;</li>
<li><a href="https://webpack.js.org/">webpack</a> bundles static resources and helps with production tasks like minification;</li>
<li><a href="https://webpack.js.org/guides/development/">webpack-dev-server</a> offers hot-reloading in development, so you can instantly see changes to frontend code upon save.</li>
</ul>
<p>See our <a href="https://github.com/code-for-canada/bdit-webapp-template">Vue webapp template</a> for more details on configuration here.</p>
<h1 id="source-control">Source Control <a class="direct-link" href="#source-control">#</a></h1>
<blockquote cite="https://perl.plover.com/classes/git/samples/slide034.html">
  <p>
It is easy to shoot your foot off with git,
but also easy to revert to a previous foot and merge it with your current leg.
</p>
  <footer>&ndash; Jack William Bell, <cite><a href="https://perl.plover.com/classes/git/samples/slide034.html">Linus Torvalds' Greatest Invention</a></footer>
</blockquote>
<p>Every development project should start with source control.  In our case, the Big Data Innovation Team uses both private and public repos on Github.  Our project is internal-only, so I made a private repo on Github.</p>
<p>Our <a href="https://github.com/code-for-canada/bdit-webapp-template">Vue webapp template</a> is based on that private repo, but with anything specific to the City environment (IP addresses, other credentials) removed.</p>
<h1 id="sample-application">Sample Application <a class="direct-link" href="#sample-application">#</a></h1>
<p>Once I had the tech stack picked, I built a sample application that exercised every part of this stack.<br>
For source code, head over to <a href="https://github.com/code-for-canada/bdit-webapp-template">bdit-webapp-template</a>.</p>
<p>There's a login form tied to <a href="https://github.com/hapijs/hapi-auth-cookie">hapi-auth-cookie</a>:</p>
<p><img src="/img/savageinternet/sample-login.png" alt="Sample Application Login" title="Sample Application Login Page"></p>
<p>For now, the username and password are hardcoded in <code>lib/config.js</code>.  This file is explicitly <code>.gitignore</code>'d to prevent leaking credentials through source control.</p>
<p>After you log in, you're greeted with this homepage:</p>
<p><img src="/img/savageinternet/sample-home.png" alt="Sample Application Homepage" title="Sample Application Home Page"></p>
<p>There's a logout feature, to test that we can clear our authentication cookie properly.  Login and logout are handled by <code>POST /login</code> and <code>POST /logout</code> respectively in our <code>hapi</code>-based REST API server.</p>
<p>Clicking on &quot;About&quot; brings you to the truly dynamic part:</p>
<p><img src="/img/savageinternet/sample-about.png" alt="Sample Application Dynamic" title="Sample Application Dynamic About Page"></p>
<p>This is where the database and REST API server come in!  There's a single table <code>&quot;TEST&quot;.&quot;COUNTER&quot;</code> with a single row:</p>
<pre class="language-sql"><code class="language-sql">psql<span class="token operator">></span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"TEST"</span><span class="token punctuation">.</span><span class="token string">"COUNTER"</span><span class="token punctuation">;</span><br> n<br><span class="token comment">---</span><br> <span class="token number">0</span><br><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">row</span><span class="token punctuation">)</span></code></pre>
<p>Our <a href="https://github.com/code-for-canada/bdit-webapp-template/blob/master/server.js">REST API server</a> offers three counter-related endpoints:</p>
<ul>
<li><code>GET /counter</code> gets the current value of the counter;</li>
<li><code>PUT /counter</code> adds 1 to the counter;</li>
<li><code>DELETE /counter</code> resets the counter to 0.</li>
</ul>
<p>When the &quot;About&quot; page is loaded, we make a request to <code>GET /counter</code> to initialize the counter state in our frontend.  &quot;Increment&quot; makes a request to <code>PUT /counter</code>, &quot;Reset&quot; makes a request to <code>DELETE /counter</code>.</p>
<p>In development, frontend static resources are served from <code>webpack-dev-server</code>, which proxies requests from <code>https://localhost:8080/flashcrow/api/(.*)</code> to our REST API server at <code>https://localhost:8081/$1</code>:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// vue.config.js</span><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token literal-property property">publicPath</span><span class="token operator">:</span> <span class="token string">'/flashcrow/'</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">https</span><span class="token operator">:</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> cert <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token string-property property">'/flashcrow/api'</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'https://localhost:8081/'</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">pathRewrite</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>          <span class="token string-property property">'^/flashcrow/api'</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>We serve the application at <code>/flashcrow</code>, mainly so that we have the flexibility to run other applications on the same machine if needed for the project.</p>
<p>For production, <code>npm run build</code> writes static resources to <code>dist</code>.  To serve those alongside our REST API server from a single port, I brought in <a href="https://www.nginx.com/">nginx</a> as a front-end proxy:</p>
<pre class="language-nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">location</span> /flashcrow</span> <span class="token punctuation">{</span><br>    <span class="token directive"><span class="token keyword">alias</span> /path/to/dist</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token directive"><span class="token keyword">location</span> /flashcrow/api</span> <span class="token punctuation">{</span><br>    <span class="token directive"><span class="token keyword">rewrite</span> /flashcrow/api/(.*) /<span class="token variable">$1</span> break</span><span class="token punctuation">;</span><br>    <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8081</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>The combination of <code>rewrite</code> and <code>proxy_pass</code> here achieves much the same thing as <code>devServer.proxy</code> above.</p>
<h1 id="testing-infrastructure">Testing Infrastructure <a class="direct-link" href="#testing-infrastructure">#</a></h1>
<p>With a sample application up and running, it was time to focus on making sure we could test everything.</p>
<p>During the Vue CLI project initialization, I also set up <a href="https://jestjs.io/">Jest</a> for unit testing and <a href="https://www.cypress.io/">Cypress</a> for end-to-end browser testing.  <code>@vue/cli-plugin-unit-jest</code> sadly isn't compatible out-of-box with <code>@babel/core</code> yet, but you can follow <a href="https://github.com/vuejs/vue-cli/issues/1584#issuecomment-460786298">these instructions</a> to get it working.</p>
<p>For Cypress, I ran into a <a href="https://github.com/cypress-io/cypress/issues/733">well-known issue</a> with installing Cypress binaries behind a corporate proxy.  To fix this, I had to <a href="https://docs.cypress.io/guides/getting-started/installing-cypress.html#Direct-download">download the binaries manually</a>, then move them into the appropriate Cypress cache directory; this causes the post-install script to skip downloading.</p>
<h2 id="component-testing">Component Testing <a class="direct-link" href="#component-testing">#</a></h2>
<p>With <a href="https://vue-test-utils.vuejs.org/">@vue/test-utils</a>, we can mount components within Jest suites:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">'@/views/Home.vue'</span><span class="token punctuation">;</span><br><br><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Home.vue renders properly'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Home<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">propsData</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>You can do plenty more with <code>@vue/test-utils</code>: issue mouse / keyboard events to specific elements within the component, test lifecycle methods, and so on.</p>
<h2 id="database-testing">Database Testing <a class="direct-link" href="#database-testing">#</a></h2>
<p><code>CounterDAO</code> is our <a href="https://en.wikipedia.org/wiki/Data_access_object">data access object</a> for handling counter fetches and updates in the sample application.  To test it, we can just <code>import CounterDAO</code> from a Jest suite like any other library:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">import</span> db <span class="token keyword">from</span> <span class="token string">'@/../lib/db/db'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> CounterDAO <span class="token keyword">from</span> <span class="token string">'@/../lib/db/CounterDAO'</span><span class="token punctuation">;</span><br><br><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'CounterDAO works properly'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>CounterDAO<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolves<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>CounterDAO<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolves<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>CounterDAO<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolves<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>CounterDAO<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolves<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>CounterDAO<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolves<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>CounterDAO<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolves<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>CounterDAO<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolves<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>CounterDAO<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolves<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  db<span class="token punctuation">.</span>$pool<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Note the call to <a href="https://github.com/vitaly-t/pg-promise">pg-promise</a>'s <code>db.$pool.end()</code> at the end: without this, the event loop hangs forever, and the test eventually times out!</p>
<h2 id="rest-api-testing">REST API Testing <a class="direct-link" href="#rest-api-testing">#</a></h2>
<p>And our REST API layer, which we can also test in a Jest suite using <a href="https://github.com/request/request-promise-native">request-promise-native</a>:</p>
<pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'counters work'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">await</span> <span class="token function">fcLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">let</span> response<span class="token punctuation">;</span><br><br>  response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fcApi</span><span class="token punctuation">(</span><span class="token string">'/counter'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'DELETE'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fcApi</span><span class="token punctuation">(</span><span class="token string">'/counter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fcApi</span><span class="token punctuation">(</span><span class="token string">'/counter'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'PUT'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fcApi</span><span class="token punctuation">(</span><span class="token string">'/counter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">await</span> <span class="token function">fcApi</span><span class="token punctuation">(</span><span class="token string">'/counter'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'PUT'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fcApi</span><span class="token punctuation">(</span><span class="token string">'/counter'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'PUT'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fcApi</span><span class="token punctuation">(</span><span class="token string">'/counter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>This is set up to run against <code>https://localhost:8080</code>, which means running <code>webpack-dev-server</code> and <code>node server.js</code> in development.</p>
<h2 id="end-to-end-ui-testing">End-to-End UI Testing <a class="direct-link" href="#end-to-end-ui-testing">#</a></h2>
<p>Finally, we have end-to-end UI tests in Cypress:</p>
<pre class="language-js"><code class="language-js">$ clear<br><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Counter Test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    cy<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    Cypress<span class="token punctuation">.</span>Cookies<span class="token punctuation">.</span><span class="token function">preserveOnce</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cy<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'a#link_about'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Reset counter'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'button#btn_reset'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cy<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'span#info_counter'</span><span class="token punctuation">,</span> <span class="token string">'Counter: 0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">'not.be.null'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Increment counter'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'button#btn_reset'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'button#btn_increment'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cy<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'span#info_counter'</span><span class="token punctuation">,</span> <span class="token string">'Counter: 1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">'not.be.null'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'button#btn_increment'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cy<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'span#info_counter'</span><span class="token punctuation">,</span> <span class="token string">'Counter: 2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">'not.be.null'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Fantastic!  We can test our application from top to bottom, right out of the gate.</p>
<h1 id="code-style">Code Style <a class="direct-link" href="#code-style">#</a></h1>
<blockquote cite="https://groups.google.com/forum/#!msg/comp.lang.c++/rYCO5yn4lXw/oITtSkZOtoUJ">
  <p>
Always code as if the guy who ends up maintaining your code will be a
violent psychopath who knows where you live.  Code for readability.
</p>
  <footer>&ndash; John F. Woods, <cite><a href="https://groups.google.com/forum/#!msg/comp.lang.c++/rYCO5yn4lXw/oITtSkZOtoUJ">comp.lang.c++</a></footer>
</blockquote>
<p>The Code for Canada fellowship is 10 short months: 4 down, 6 to go.  I might be the only developer on this project right now, but what about after I'm gone?  What if we get another developer on the team mid-fellowship?  (This isn't purely hypothetical: BDIT mentioned we might be able to get 1-2 more devs.)  Professional software development means writing code others can read and modify.</p>
<p>A big part of that is <em>code style</em>, a set of rules that describe what readable code means in your organization.  To help set that up, Vue CLI comes with <a href="https://www.npmjs.com/package/lint-staged">lint-staged</a> and <a href="https://www.npmjs.com/package/@vue/cli-plugin-eslint">@vue/cli-plugin-eslint</a>, with <a href="https://www.npmjs.com/package/@vue/eslint-config-airbnb">@vue/eslint-config-airbnb</a> installed to use <a href="https://github.com/airbnb/javascript">AirBnB's excellent JavaScript style guide</a> by default.</p>
<p>I added <a href="https://www.pylint.org/">pylint</a> for Python, <a href="https://github.com/PowerShell/PSScriptAnalyzer">PSScriptAnalyzer</a> for PowerShell scripts, and <a href="https://www.shellcheck.net/">shellcheck</a> for Bash scripts.  This was also a good point to integrate unit testing into our pre-commit hook:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"test:unit"</span><span class="token operator">:</span> <span class="token string">"jest --changedSince=master"</span><span class="token punctuation">,</span><br>    <span class="token property">"pre-commit:lint"</span><span class="token operator">:</span> <span class="token string">"lint-staged"</span><span class="token punctuation">,</span><br>    <span class="token property">"pre-commit:audit"</span><span class="token operator">:</span> <span class="token string">"npm audit"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"gitHooks"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"pre-commit"</span><span class="token operator">:</span> <span class="token string">"npm-run-all pre-commit:* test:unit"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"lint-staged"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"*.js"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"vue-cli-service lint"</span><span class="token punctuation">,</span><br>      <span class="token string">"git add"</span><br>    <span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token property">"*.vue"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"vue-cli-service lint"</span><span class="token punctuation">,</span><br>      <span class="token string">"git add"</span><br>    <span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token property">"*.py"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"pylint"</span><span class="token punctuation">,</span><br>      <span class="token string">"git add"</span><br>    <span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token property">"*.ps1"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"python ./scripts/dev/ps1_linter.py"</span><span class="token punctuation">,</span><br>      <span class="token string">"git add"</span><br>    <span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token property">"*.sh"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"shellcheck --shell=bash"</span><span class="token punctuation">,</span><br>      <span class="token string">"git add"</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Note that I've also added <a href="https://docs.npmjs.com/cli/audit">npm audit</a>, which flags npm packages in your project with known vulnerabilities.  Solid pre-commit hooks are an essential part of maintaining code readability, quality, and security!</p>
<h1 id="last-thoughts">Last Thoughts <a class="direct-link" href="#last-thoughts">#</a></h1>
<p>Phew!  It sounds like a lot of work, but some technical due diligence up front saves loads of effort later.  It's always easier to integrate best practices like end-to-end testing, pre-commit hooks, etc. into a fresh project than it is to shoehorn them into an existing legacy codebase.  If you have the chance, why not do it when it's easy?  Your future team will thank you.</p>
<p>I've also been busy setting up a replication pipeline between Oracle and PostgreSQL, which I might explain in a future blog post (time permitting).  We'll soon be starting in on development, so look forward to more technical deep-dives!</p>


<hr>
<ul><li>Previous: <a href="/posts/savageinternet/2017-07-09-the-limitations-of-real/">The Limitations of Real</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /posts/savageinternet/2019-02-09-on-process-planning-for-tech-success-in-government/ -->
  </body>
</html>
