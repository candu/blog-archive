<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadtree Cartography</title>
    <meta name="description" content="Evan Savage&#39;s personal blog about software, life, travel, and other sundry things.">
    <link href='http://fonts.googleapis.com/css?family=PT%20Serif:400,400italic,500,500italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Evan Savage">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Evan Savage">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Evan Savage</a></h1>

      <ul class="nav">
          <li class="nav-item"><a href="/">Home</a></li>
          <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="https://savageevan.com">About Me</a></li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>Quadtree Cartography</h1>

<p>In this post, I show off some images from a project I'm working on (which will<br>
remain nameless for now!) These images visualize subdivisions of the Earth<br>
into Google Maps tile-sized regions with roughly equal population. I'll also<br>
provide a brief and non-technical rundown of the process by which I generated<br>
these images.</p>
<!-- more -->
<h2 id="the-images">The Images <a class="direct-link" href="#the-images">#</a></h2>
<p>First, a representative image from my renderings:</p>
<img src="https://lh5.googleusercontent.com/-EmN0ma8uhtg/USZnFkGsrfI/AAAAAAAAAV8/hDpa5sx1-IE/s640/tiles11.ag.jpg" />
<p>I love working on problems with a visual aspect - you get direct sensory<br>
feedback on your progress!</p>
<p>Here, we can clearly see the continents delineated<br>
by dense coastal population clusters. India and China are especially detailed,<br>
and Europe has fairly uniform density throughout. Contrast this with North<br>
America: northern Canada is sparsely populated, as are the deserts and<br>
mountains of the Central United States.</p>
<p>Next, some renderings at different subdivision levels (Google Maps zoom<br>
levels 8-11):</p>
<img src="https://lh4.googleusercontent.com/-SqLGYcz6yl0/USZnBXDoUNI/AAAAAAAAAUs/C7vdLkL522Y/s288/tiles8.ag60.jpg" />
<img src="https://lh5.googleusercontent.com/-m2wk-ov9Mw4/USZnBmDUucI/AAAAAAAAAU0/vrU48gzJei4/s288/tiles9.ag60.jpg" />
<img src="https://lh6.googleusercontent.com/-GuXnAIjWUf0/USZnCbAac_I/AAAAAAAAAU8/urh1UXBD3-U/s288/tiles10.ag60.jpg" />
<img src="https://lh6.googleusercontent.com/-Y53pPe7T0II/USZnCn5ZL3I/AAAAAAAAAVI/Owjf_pnQBic/s288/tiles11.ag60.jpg" />
<p>As the subdivision level increases, the continents progress from blocky pixel<br>
art to more recognizable shapes.</p>
<p>Finally, some renderings with different resolutions of the underlying population<br>
data (degree, half-degree, quarter-degree, and 2.5 arc minutes):</p>
<img src="https://lh6.googleusercontent.com/-GuXnAIjWUf0/USZnCbAac_I/AAAAAAAAAU8/urh1UXBD3-U/s288/tiles10.ag60.jpg" />
<img src="https://lh6.googleusercontent.com/-RRw5Gx4OiaA/USZnEQhqNhI/AAAAAAAAAVg/i6B3yx8BF_M/s288/tiles10.ag30.jpg" />
<img src="https://lh5.googleusercontent.com/-NkGpf7zzHsY/USZnFI4qQ7I/AAAAAAAAAV4/Kl1UB4U-4pU/s288/tiles10.ag15.jpg" />
<img src="https://lh6.googleusercontent.com/-n6Ufe_6mJzM/USZnF60IfvI/AAAAAAAAAWE/PEmAgvWvzNU/s288/tiles10.ag.jpg" />
<p>Here the effect is more subtle: detail is added in densely populated areas,<br>
but larger tiles (corresponding to more remote regions) are mostly unaffected.</p>
<p>To see all the images as small multiples, <a href="https://picasaweb.google.com/100933554722754572774/20130221QuadtreeCartography#">view the album on Picasa</a>.</p>
<h2 id="the-process">The Process <a class="direct-link" href="#the-process">#</a></h2>
<p>There are four major steps: getting the data, combining it with Google Maps<br>
tile data, building the subdivision, and rendering it.</p>
<h3 id="getting-the-data">Getting the Data <a class="direct-link" href="#getting-the-data">#</a></h3>
<p>The <a href="http://sedac.ciesin.columbia.edu/citations">NASA Socio-Economic Data and Applications Center</a>,<br>
or SEDAC, compiles global population grids. These grids contain the estimated<br>
number of people living in each 2.5-arc-minute square of the Earth's surface.<br>
2.5 arc-minutes is 1/24 of a degree, or about 4.5 km of equatorial circumference:<br>
definitely high-resolution enough for building some awesome maps!</p>
<p>The population count grids are available <a href="http://sedac.ciesin.columbia.edu/data/set/gpw-v3-population-count/data-download">here</a>.<br>
You have to register on the site and cite usage of their data, but otherwise it<br>
appears to be freely available.</p>
<h3 id="combining-with-google-maps">Combining with Google Maps <a class="direct-link" href="#combining-with-google-maps">#</a></h3>
<p>Google Maps uses a <a href="http://en.wikipedia.org/wiki/Mercator_projection">Mercator projection</a>.<br>
This projection is <a href="https://developers.google.com/maps/documentation/javascript/maptypes#WorldCoordinates">truncated</a><br>
at roughly 85 degrees latitude to create a square map, which is then projected<br>
onto a 256 x 256 world coordinate system. Finally, world coordinates are<br>
mapped to <a href="https://developers.google.com/maps/documentation/javascript/maptypes#PixelCoordinates">pixel coordinates</a><br>
at different zoom levels, which determine which <a href="https://developers.google.com/maps/documentation/javascript/maptypes#TileCoordinates">tile</a><br>
your location falls in.</p>
<p>To match up the gridded population data with Google Maps tiles, then, we need<br>
to do the following:</p>
<ul>
<li>for each grid cell, <em>determine its latitude and longitude boundaries</em>;</li>
<li>use those boundaries to <em>figure out which map tiles the cell overlaps</em>;</li>
<li><em>divide the cell's population among those map tiles</em>.</li>
</ul>
<p>To divide the cell's population fairly, I determine how much of the cell<br>
overlaps each tile.</p>
<p>I found <a href="https://google-developers.appspot.com/maps/documentation/javascript/examples/map-coordinates">this helpful example</a><br>
of working with locations, world coordinates, pixel coordinates, and tiles.<br>
The source code of that example contains an implementation of Google's<br>
Mercator projection, which I built into a larger <a href="http://nodejs.org/">node.js</a><br>
utility for computing the equal-population subdivision.</p>
<p>(Yes, node.js is fine for CPU-intensive tasks, just not in the same process<br>
as your webserver.)</p>
<h3 id="building-an-equal-population-subdivision">Building an Equal-Population Subdivision <a class="direct-link" href="#building-an-equal-population-subdivision">#</a></h3>
<p>To get map tiles of equal population, <em>I combine tiles into larger tiles<br>
until the population exceeds a threshold.</em> This creates large tiles in<br>
sparsely populated areas while leaving smaller tiles in densely populated<br>
areas.</p>
<p>(I mentioned <a href="http://blog.notdot.net/2009/11/Damn-Cool-Algorithms-Spatial-indexing-with-Quadtrees-and-Hilbert-Curves">quadtrees</a><br>
in the title of this post - this data structure is ideally suited for the<br>
problem.)</p>
<h3 id="rendering-the-subdivision">Rendering the Subdivision <a class="direct-link" href="#rendering-the-subdivision">#</a></h3>
<p>This is the easy part! I used <a href="https://pypi.python.org/pypi/Pillow/">Pillow</a>, a<br>
nicely-packaged version of the excellent <a href="http://www.pythonware.com/products/pil/">Python Imaging Library</a>,<br>
to render the subdivisions out as JPEG images.</p>
<p>(I suppose I could have rendered SVG images in node.js using some <a href="https://github.com/tmpvar/jsdom">jsdom</a><br>
and <a href="http://d3js.org/">d3</a> hackery, but I was already familiar with using<br>
Python Imaging Library for image synthesis.)</p>


<hr>
<ul><li>Next: <a href="/posts/2013-03-04-another-quadtree-map-rendering/">Another Quadtree Map Rendering</a></li><li>Previous: <a href="/posts/2013-02-07-applying-genetic-research-to-my-23andme-data/">Applying Genetic Research To My 23andMe Data</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /posts/2013-02-21-quadtree-cartography/ -->
  </body>
</html>
