<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Tracking: Mint Bubbles</title>
    <meta name="description" content="Evan Savage&#39;s personal blog about software, life, travel, and other sundry things.">
    <link href='http://fonts.googleapis.com/css?family=PT%20Serif:400,400italic,500,500italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Evan Savage">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Evan Savage">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Evan Savage</a></h1>

      <ul class="nav">
          <li class="nav-item"><a href="/">Home</a></li>
          <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="https://savageevan.com">About Me</a></li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>Financial Tracking: Mint Bubbles</h1>

<p>In this post I present Mint Bubbles, a <a href="http://www.nytimes.com/interactive/2012/02/13/us/politics/2013-budget-proposal-graphic.html">force-directed bubble chart</a><br>
visualization of exported Mint data. I explain how to use<br>
<a href="http://en.wikipedia.org/wiki/Force-based_algorithms_(graph_drawing)">force-directed layouts</a> to produce awesome interactive visualizations<br>
with <a href="http://d3js.org/">d3</a>, and also provide details on some of the specific tricks used<br>
to create Mint Bubbles.</p>
<!-- more -->
<h2 id="getting-your-data">Getting Your Data <a class="direct-link" href="#getting-your-data">#</a></h2>
<p>Exporting your data from Mint is easy. Log into Mint and go to the<br>
Transactions tab:</p>
<img src="https://lh6.googleusercontent.com/-oHWRFHUK35A/UKLVzn8tlDI/AAAAAAAAAM4/_2mADDMZ__M/s640/transactions-tab-select.jpg" />
<p>Scroll to the bottom pagination section. In barely-legible super-tiny<br>
type at bottom right, there's a link to export all your transactions:</p>
<img src="https://lh3.googleusercontent.com/-VSYonXZ14ns/UKLVz3M9eHI/AAAAAAAAAMs/Svbd25tzd3A/s800/transactions-export-link.jpg" />
<p>Clicking that link will download a file called <code>transactions.csv</code>:</p>
<img src="https://lh6.googleusercontent.com/-iwz7B_kEtF8/UKLV0RLGvZI/AAAAAAAAAM0/w3tqQ53CVao/s800/transactions-csv-download.jpg" />
<h2 id="mint-bubbles">Mint Bubbles <a class="direct-link" href="#mint-bubbles">#</a></h2>
<p>If you're viewing this on an RSS reader, check out the example<br>
<a href="/blog/2012/11/12/financial-tracking-mint-bubbles/#quick-demo">on my blog</a>. You will need a browser that supports the<br>
<a href="https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications">HTML5 File API</a>.</p>
<p>You can see the code for this demo <a href="https://github.com/candu/quantified-savagery-files/tree/master/Financial/mint-bubbles">here</a>.</p>
<p>To see a visualization of your data, drag the <code>transactions.csv</code> file from<br>
Mint onto the <code>drag your data here</code> area below. You can also use<br>
<a href="http://candu.github.io/quantified-savagery-files/Financial/mint-bubbles/transactions.csv">my data</a> from the last three months or so.</p>
<div id="quick-demo" markdown="0">
  <style type="text/css">
    #quick-demo {
      line-height: 1;
    }
<pre><code>#chart {
  height: 480px;
  width: 720px;
  margin: auto;
  margin-top: 32px;
  margin-bottom: 16px;
}

.chart-active {
  border: 1px solid #DFE2E1;
  background-color: #F7F7F7;
}

#drop_zone {
  display: table;
  border: 2px dashed #bbb;
  height: 100%;
  width: 100%;
  padding: 4px;
  cursor: pointer;
}

#drop_zone p {
  display: table-cell;
  vertical-align: middle;
  text-align: center;
  font-size: 150%;
  color: #7F7F7F;
}

.hidden {
  display: none !important;
}

circle.node {
  cursor: pointer;
}

circle.circle-active {
  fill: #36f !important;
  stroke: #03f !important;
}

#caption {
  width: 720px;
  margin: auto;
  text-align: center;
  min-height: 100%;
}

#total {
  font-size: 125%;
  color: #36f;
  padding: 4px;
  margin-bottom: 8px;
}

#prompt {
  font-size: 150%;
  color: #888;
  padding: 4px;
}

#transactions_table {
  width: 100%;
  margin-bottom: 8px;
}

#quick-demo th {
  font-weight: 500;
  padding-bottom: 4px;
}

#quick-demo th, #quick-demo td {
  text-align: center;
}
</code></pre>
  </style>
  <script src="http://candu.github.io/quantified-savagery-files/lib/js/third-party/mootools.js"></script>
  <script src="http://candu.github.io/quantified-savagery-files/lib/js/third-party/d3.js"></script>
  <script src="http://candu.github.io/quantified-savagery-files/Financial/mint-bubbles/demo.js"></script>
  <div id="chart">
    <div id="drop_zone">
      <p>
        drop your data here
        <div id="progress" class="hidden">
          <progress id="progress_bar"></progress>
        </div>
      </p>
    </div>
  </div>
  <div id="caption" class="hidden">
    <div id="prompt">
      click bubbles to see transaction details
    </div>
    <div id="total" class="hidden"></div>
    <div id="transactions" class="hidden">
      <table id="transactions_table">
        <thead>
          <tr>
            <th width="120px">Date</th>
            <th width="120px">Amount</th>
            <th width="480px">Description</th>
          </tr>
        </thead>
        <tbody id="transactions_tbody"></tbody>
      </table>
    </div>
  </div>
</div>
<h2 id="behind-the-bubbles">Behind The Bubbles <a class="direct-link" href="#behind-the-bubbles">#</a></h2>
<h3 id="inspiration">Inspiration <a class="direct-link" href="#inspiration">#</a></h3>
<p>This visualization was inspired by the<br>
<a href="http://www.nytimes.com/interactive/2012/02/13/us/politics/2013-budget-proposal-graphic.html">NYT 2013 Budget Proposal Graphic</a>,<br>
which uses <a href="http://d3js.org/">d3.js</a> to bring<br>
<a href="http://www.whitehouse.gov/omb/budget">Obama's 2013 budget proposal</a><br>
to life as an interactive bubble chart.</p>
<p>I'd just started using <a href="https://www.mint.com/">Mint</a> for financial tracking, and this<br>
seemed like an awesome way to visualize my personal spending patterns.<br>
To help figure out the mechanics of the NYT visualization, I consulted<br>
<a href="http://vallandingham.me/bubble_charts_in_d3.html">this article</a><br>
by <a href="http://vallandingham.me/">Jim Vallandingham</a>. He explains in detail how to create similar<br>
visualizations using d3's <a href="https://github.com/mbostock/d3/wiki/Force-Layout">force-directed layouts</a>, which model your<br>
data as a set of particles moving about in space.</p>
<h3 id="importing-data">Importing Data <a class="direct-link" href="#importing-data">#</a></h3>
<p>Unlike my <a href="/blog/2012/10/22/dont-hate-cross-correlate/#quick-demo">previous</a> <a href="/blog/2012/10/17/fitbit-apis-crossfilter-and-d3/#quick-demo">visualizations</a>, I wanted this visualization<br>
to allow you to play with your data. Enter the <a href="http://www.html5rocks.com/en/tutorials/file/dndfiles/">HTML5 File API</a>, which<br>
allows access to files via JavaScript. First, I set up the drag-and-drop<br>
listeners on <code>div#drop_zone</code>:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">/*<br> * Octopress bundles ender.js, which provides $() for DOM access; mootools<br> * tries to play nice, so it won't install its $() over that. I'm using<br> * document.id() instead.<br> */</span><br><span class="token keyword">var</span> dropZone <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">'drop_zone'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">function</span> <span class="token function">trapEvent</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  evt<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  evt<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br>dropZone<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragenter'</span><span class="token punctuation">,</span> trapEvent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>dropZone<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragexit'</span><span class="token punctuation">,</span> trapEvent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>dropZone<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragover'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">trapEvent</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// This makes a copy icon appear during the drag operation.</span><br>  evt<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span>dropEffect <span class="token operator">=</span> <span class="token string">'copy'</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>dropZone<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'drop'</span><span class="token punctuation">,</span> handleFileSelect<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><code>dragenter</code>, <code>dragexit</code>, and <code>dragover</code> are analogous to <code>mouseenter</code>,<br>
<code>mouseexit</code>, and <code>mouseover</code>. For those events, it suffices to call<br>
<code>trapEvent()</code>, which prevents the browser's default action from happening.<br>
For instance, Chrome on Mac OS will just download the <code>transactions.csv</code> file<br>
if you drag it into a browser tab, which is not what I want here.</p>
<p><code>drop</code> is the interesting event:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">handleFileSelect</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">trapEvent</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> f <span class="token operator">=</span> evt<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token comment">// NOTE: you might want to filter out large or invalid files here.</span><br>  <span class="token keyword">var</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  reader<span class="token punctuation">.</span><span class="token function-variable function">onloadstart</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      document<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">'progress'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      document<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">'progress_bar'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      document<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">'progress_bar'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'max'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  reader<span class="token punctuation">.</span><span class="token function-variable function">onprogress</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      document<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">'progress_bar'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> e<span class="token punctuation">.</span>loaded<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    document<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">'caption'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'chart-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    document<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">'progress'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    document<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">'drop_zone'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    document<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">'chart'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'chart-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">buildChart</span><span class="token punctuation">(</span>d3<span class="token punctuation">.</span>csv<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  reader<span class="token punctuation">.</span><span class="token function">readAsText</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>This uses <code>FileReader.readAsText()</code> to read in the <code>transactions.csv</code> file,<br>
with <code>d3.csv.parse()</code> for turning that CSV file into a sequence of JavaScript<br>
objects representing the transactions. This parsing is triggered <code>onload</code>,<br>
which fires once file I/O has completed.</p>
<p><code>onloadstart</code> and <code>onprogress</code> are used to monitor file I/O progress via the<br>
<a href="http://www.useragentman.com/blog/2012/01/03/cross-browser-html5-progress-bars-in-depth/">HTML5 progress element</a> <code>document.id('progress_bar')</code>. Since<br>
<code>transactions.csv</code> files are typically small, and since the &quot;uploading&quot; is<br>
actually a client-local copy into browser memory, you'll probably never see<br>
that progress bar.</p>
<h3 id="grouping-transactions">Grouping Transactions <a class="direct-link" href="#grouping-transactions">#</a></h3>
<p>I group the transactions by category:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> cs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>data<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> c <span class="token operator">=</span> tx<span class="token punctuation">[</span><span class="token string">'Category'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>c <span class="token keyword">in</span> cs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    cs<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><br>      amount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>      txs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  cs<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>amount <span class="token operator">+=</span> <span class="token operator">+</span><span class="token punctuation">(</span>tx<span class="token punctuation">[</span><span class="token string">'Amount'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  cs<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>txs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><code>amount</code> stores the total amount; note the use of <code>+(tx['Amount'])</code> to convert<br>
CSV string values into numbers. <code>txs</code> is used for the transaction list.</p>
<p>I then convert these into nodes to be used by<br>
<code>d3.layout.force()</code>:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> c <span class="token keyword">in</span> cs<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token constant">R</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>cs<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    category<span class="token operator">:</span> c<span class="token punctuation">,</span><br>    amount<span class="token operator">:</span> cs<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>amount<span class="token punctuation">,</span><br>    txs<span class="token operator">:</span> cs<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>txs<br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<h3 id="defining-the-layout">Defining The Layout <a class="direct-link" href="#defining-the-layout">#</a></h3>
<p>Before building the visualization itself, I define a color gradient based on<br>
bubble radius, picking the colors using the excellent<br>
<a href="http://colorschemedesigner.com/">Color Scheme Designer</a>:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> Rs <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token constant">R</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> minR <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>Rs<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    maxR <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>Rs<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> fill <span class="token operator">=</span> d3<span class="token punctuation">.</span>scale<span class="token punctuation">.</span><span class="token function">linear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">domain</span><span class="token punctuation">(</span><span class="token punctuation">[</span>minR<span class="token punctuation">,</span> maxR<span class="token punctuation">]</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'#7EFF77'</span><span class="token punctuation">,</span> <span class="token string">'#067500'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Now on to the visualization. First, I need to create the <a href="https://developer.mozilla.org/en-US/docs/SVG">SVG element</a>:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> w <span class="token operator">=</span> <span class="token number">960</span><span class="token punctuation">,</span> h <span class="token operator">=</span> <span class="token number">480</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> vis <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'#chart'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'svg:svg'</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Next, I define the behavior and styling of the bubbles:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> node <span class="token operator">=</span> vis<span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token string">'circle.node'</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'svg:circle'</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'node'</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'cx'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'cy'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span>y<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token constant">R</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token string">'fill'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">fill</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token constant">R</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token string">'stroke'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> d3<span class="token punctuation">.</span><span class="token function">rgb</span><span class="token punctuation">(</span><span class="token function">fill</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token constant">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token string">'stroke-width'</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><code>fill(d.R)</code> uses the color gradient <code>fill</code> to make smaller bubbles lighter and<br>
larger bubbles darker.</p>
<p>As for the force-directed layout, I start with some basic properties:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> force <span class="token operator">=</span> d3<span class="token punctuation">.</span>layout<span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">nodes</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">links</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>          <span class="token comment">// no edges between bubbles!</span><br>  <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">[</span>w<span class="token punctuation">,</span> h<span class="token punctuation">]</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">gravity</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span>      <span class="token comment">// controls speed at which bubbles seek the center</span><br>  <span class="token punctuation">.</span><span class="token function">friction</span><span class="token punctuation">(</span><span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// slows down motion</span></code></pre>
<h3 id="tick-handler">Tick Handler <a class="direct-link" href="#tick-handler">#</a></h3>
<blockquote cite="https://github.com/mbostock/d3/wiki/Force-Layout#wiki-tick">
  <p>
`force.tick()`: Runs the force layout simulation one step.
</p>
  <footer>&ndash; Mike Bostock, <cite><a href="https://github.com/mbostock/d3/wiki/Force-Layout#wiki-tick">Force Layout</a></footer>
</blockquote>
<p>Force-directed layouts model your data as a set of particles in space. Those<br>
particles are subject to various forces:</p>
<ul>
<li><strong>Gravity:</strong> in d3, this is actually an attractive force pulling particles<br>
towards the center of the visualization.</li>
<li><strong>Friction:</strong> this slows down movement.</li>
<li><strong>Tension:</strong> if nodes are connected via links (edges), they will resist being<br>
moved apart.</li>
<li><strong>Charge:</strong> similar to electric charge, same-signed charges repel<br>
and opposite-signed charges attract.</li>
</ul>
<p>A layout can describe some or all of these forces. Resolving the forces is a<br>
simple iterative process:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token constant">P</span> <span class="token keyword">in</span> particles<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token constant">F</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span>f <span class="token keyword">in</span> <span class="token function">forcesActingOn</span><span class="token punctuation">(</span><span class="token constant">P</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token constant">F</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token constant">F</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> f<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token function">applyForceTo</span><span class="token punctuation">(</span><span class="token constant">P</span><span class="token punctuation">,</span> <span class="token constant">F</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>In addition to the above forces, visualizations using <code>d3.layout.force()</code> can<br>
define their own forces via the <code>ontick</code> handler. I use this to apply two<br>
effects:</p>
<ul>
<li><strong>Size Sorting:</strong> similar to <a href="http://en.wikipedia.org/wiki/Granular_convection">granular convection</a>,<br>
larger bubbles will rise while smaller bubbles sink.</li>
<li><strong>Collision Detection:</strong> I prevent bubbles from intersecting, since that<br>
makes it easier to select them.</li>
</ul>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> floatPoint <span class="token operator">=</span> d3<span class="token punctuation">.</span>scale<span class="token punctuation">.</span><span class="token function">linear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">domain</span><span class="token punctuation">(</span><span class="token punctuation">[</span>minR<span class="token punctuation">,</span> maxR<span class="token punctuation">]</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token punctuation">[</span>h <span class="token operator">*</span> <span class="token number">0.65</span><span class="token punctuation">,</span> h <span class="token operator">*</span> <span class="token number">0.35</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>force<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'tick'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// vertical size sorting</span><br>  nodes<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> dy <span class="token operator">=</span> <span class="token function">floatPoint</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token constant">R</span><span class="token punctuation">)</span> <span class="token operator">-</span> d<span class="token punctuation">.</span>y<span class="token punctuation">;</span><br>    d<span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token number">0.25</span> <span class="token operator">*</span> dy <span class="token operator">*</span> e<span class="token punctuation">.</span>alpha<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// collision detection</span><br>  <span class="token keyword">var</span> q <span class="token operator">=</span> d3<span class="token punctuation">.</span>geom<span class="token punctuation">.</span><span class="token function">quadtree</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  nodes<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    q<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">quad<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">var</span> d2 <span class="token operator">=</span> quad<span class="token punctuation">.</span>point<span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>d2 <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>d2 <span class="token operator">!==</span> d1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">var</span> x <span class="token operator">=</span> d1<span class="token punctuation">.</span>x <span class="token operator">-</span> d2<span class="token punctuation">.</span>x<span class="token punctuation">,</span><br>            y <span class="token operator">=</span> d1<span class="token punctuation">.</span>y <span class="token operator">-</span> d2<span class="token punctuation">.</span>y<span class="token punctuation">,</span><br>            <span class="token constant">L</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span><br>            <span class="token constant">R</span> <span class="token operator">=</span> d1<span class="token punctuation">.</span><span class="token constant">R</span> <span class="token operator">+</span> d2<span class="token punctuation">.</span><span class="token constant">R</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">L</span> <span class="token operator">&lt;</span> <span class="token constant">R</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token constant">L</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">L</span> <span class="token operator">-</span> <span class="token constant">R</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token constant">L</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span><br>          <span class="token keyword">var</span> Lx <span class="token operator">=</span> <span class="token constant">L</span> <span class="token operator">*</span> x<span class="token punctuation">,</span><br>              Ly <span class="token operator">=</span> <span class="token constant">L</span> <span class="token operator">*</span> y<span class="token punctuation">;</span><br>          d1<span class="token punctuation">.</span>x <span class="token operator">-=</span> Lx<span class="token punctuation">;</span> d1<span class="token punctuation">.</span>y <span class="token operator">-=</span> Ly<span class="token punctuation">;</span><br>          d2<span class="token punctuation">.</span>x <span class="token operator">+=</span> Lx<span class="token punctuation">;</span> d2<span class="token punctuation">.</span>y <span class="token operator">+=</span> Ly<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">// This short-circuits visit() for quadtree nodes that can't collide with</span><br>      <span class="token comment">// d1, resulting in O(n log n) collision detection.</span><br>      <span class="token keyword">return</span><br>        x1 <span class="token operator">></span> <span class="token punctuation">(</span>d1<span class="token punctuation">.</span>x <span class="token operator">+</span> d1<span class="token punctuation">.</span><span class="token constant">R</span><span class="token punctuation">)</span> <span class="token operator">||</span><br>        x2 <span class="token operator">&lt;</span> <span class="token punctuation">(</span>d1<span class="token punctuation">.</span>x <span class="token operator">-</span> d1<span class="token punctuation">.</span><span class="token constant">R</span><span class="token punctuation">)</span> <span class="token operator">||</span><br>        y1 <span class="token operator">></span> <span class="token punctuation">(</span>d1<span class="token punctuation">.</span>y <span class="token operator">+</span> d1<span class="token punctuation">.</span><span class="token constant">R</span><span class="token punctuation">)</span> <span class="token operator">||</span><br>        y2 <span class="token operator">&lt;</span> <span class="token punctuation">(</span>d1<span class="token punctuation">.</span>y <span class="token operator">-</span> d1<span class="token punctuation">.</span><span class="token constant">R</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  node<br>    <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'cx'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'cy'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span>y<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="alpha-and-size-sorting">Alpha and Size Sorting <a class="direct-link" href="#alpha-and-size-sorting">#</a></h3>
<p>What's <code>e.alpha</code>? This is described cryptically in the<br>
<a href="https://github.com/mbostock/d3/wiki/Force-Layout#wiki-start">d3.js documentation</a>:</p>
<blockquote cite="https://github.com/mbostock/d3/wiki/Force-Layout#wiki-start">
  <p>
Internally, the layout uses a cooling parameter alpha which controls the layout temperature: as the physical simulation converges on a stable layout, the temperature drops, causing nodes to move more slowly.
</p>
  <footer>&ndash; Mike Bostock, <cite><a href="https://github.com/mbostock/d3/wiki/Force-Layout#wiki-start">Force Layout</a></footer>
</blockquote>
<p>A look at the <a href="https://github.com/mbostock/d3/blob/master/src/layout/force.js#L46">code for d3.layout.force()</a><br>
provides some insight into what's happening here:</p>
<pre class="language-js"><code class="language-js">force<span class="token punctuation">.</span><span class="token function-variable function">tick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// simulated annealing, basically</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>alpha <span class="token operator">*=</span> <span class="token number">.99</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">.005</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    event<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">"end"</span><span class="token punctuation">,</span> alpha<span class="token operator">:</span> alpha <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre>
<p>Let's look at the size sorting code again:</p>
<pre class="language-js"><code class="language-js">nodes<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> dy <span class="token operator">=</span> <span class="token function">floatPoint</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token constant">R</span><span class="token punctuation">)</span> <span class="token operator">-</span> d<span class="token punctuation">.</span>y<span class="token punctuation">;</span><br>  d<span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token number">0.25</span> <span class="token operator">*</span> dy <span class="token operator">*</span> e<span class="token punctuation">.</span>alpha<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><code>floatPoint(d.R)</code> computes a &quot;desired height&quot; for the node <code>d</code>. The <code>d.y</code><br>
adjustment moves <code>d</code> towards that height, using <code>e.alpha</code> to slow down the<br>
sorting adjustment as the layout &quot;cools&quot; into its final state.</p>
<h3 id="collision-detection">Collision Detection <a class="direct-link" href="#collision-detection">#</a></h3>
<p>The collision detection code is cribbed from<br>
<a href="http://mbostock.github.com/d3/talk/20111018/collision.html">this page</a>,<br>
which is part of a <a href="http://mbostock.github.com/d3/talk/20111018/#0">talk</a><br>
given by <a href="http://bost.ocks.org/mike/">Mike Bostock</a> on d3.</p>
<h2 id="up-next">Up Next <a class="direct-link" href="#up-next">#</a></h2>
<p>I'm currently working on a post for the <a href="http://quantifiedself.com/">main Quantified Self blog</a>,<br>
in which I'm planning to feature another cool visualization for personal data.<br>
Aside from that, I'm hoping to use an upcoming post to dissect my Mint data in<br>
more detail. Keep posted!</p>


<hr>
<ul><li>Next: <a href="/posts/2012-11-14-sober-thoughts-on-willpower-and-decision-making/">Sober Thoughts On Willpower And Decision Making</a></li><li>Previous: <a href="/posts/2012-11-07-healthy-isnt-a-place-you-go-to/">Healthy Isn&#39;t A Place You Go To</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /posts/2012-11-12-financial-tracking-mint-bubbles/ -->
  </body>
</html>
